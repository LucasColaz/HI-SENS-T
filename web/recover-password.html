<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HI-SENS | Nueva Contraseña</title>
  <link rel="stylesheet" href="login.css">
  <style>
    .valid { color: green; text-decoration: line-through; }
    .invalid { color: #dc3545; }
    ul { list-style: none; padding: 0; font-size: 0.85rem; margin-top: 5px; }
  </style>
</head>
<body>
  <div class="login-container">
    <div class="login-header">HI-SENS</div>
    <div class="login-box">
      <h2>Establecer Nueva Contraseña</h2>
      
      <form id="recover-form">
        <div class="input-group">
          <label>Nueva Contraseña</label>
          <input type="password" id="pass1" required>
          <ul>
             <li id="req-len" class="invalid">Mínimo 8 caracteres</li>
             <li id="req-cap" class="invalid">Una mayúscula</li>
             <li id="req-num" class="invalid">Un número</li>
          </ul>
        </div>
        <div class="input-group">
          <label>Confirmar Contraseña</label>
          <input type="password" id="pass2" required>
        </div>
        
        <button type="submit" class="login-button">Cambiar Contraseña</button>
        <div id="error-msg" class="error-message hidden"></div>
      </form>
    </div>
  </div>

  <script>
    // Obtener token de la URL
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');

    if (!token) {
        document.body.innerHTML = "<h3 style='text-align:center; margin-top:50px;'>Error: Enlace inválido o incompleto.</h3>";
    }

    // Validaciones visuales
    const p1 = document.getElementById("pass1");
    p1.addEventListener("keyup", () => {
        const v = p1.value;
        document.getElementById("req-len").className = v.length >= 8 ? "valid" : "invalid";
        document.getElementById("req-cap").className = /[A-Z]/.test(v) ? "valid" : "invalid";
        document.getElementById("req-num").className = /[0-9]/.test(v) ? "valid" : "invalid";
    });

    document.getElementById("recover-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        const p2 = document.getElementById("pass2").value;
        const msg = document.getElementById("error-msg");
        msg.classList.add("hidden");

        if (p1.value !== p2) {
            msg.textContent = "Las contraseñas no coinciden.";
            msg.classList.remove("hidden");
            return;
        }

        try {
            const res = await fetch('/api/password-recovery/reset', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ token: token, new_password: p1.value })
            });
            
            const data = await res.json();
            
            if (!res.ok) throw new Error(data.detail || "Error al restablecer");

            alert("¡Contraseña actualizada! Ahora puedes iniciar sesión.");
            window.location.href = "login.html";

        } catch (error) {
            msg.textContent = error.message;
            msg.classList.remove("hidden");
        }
    });
  </script>
</body>
</html>